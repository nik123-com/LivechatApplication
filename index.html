<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Local Network Chat</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="container" id="container" style="display:none;">
      <div class="header">
        <h3>Local Network Chat</h3>
        <div class="small">Connected via same Wi-Fi</div>
      </div>

      <div class="chat-area">
        <div id="messages" class="messages"></div>
      </div>

      <div class="input-area">
        <input id="msg" placeholder="Type a message and press Send or Enter" autocomplete="off">
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      let username = "";

      // Ask username first
      while (!username) {
        username = prompt("Enter your name:")?.trim();
      }
      document.getElementById("container").style.display = "grid";

      const socket = io();
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("msg");
      const sendBtn = document.getElementById("sendBtn");

      function appendMessage(user, text, who = "other") {
        const wrap = document.createElement("div");
        wrap.className = who === "you" ? "msg you" : "msg other";
        wrap.innerHTML = `
          <div class="username">${user}</div>
          <div>${escapeHtml(text)}</div>
          <div class="meta">${new Date().toLocaleTimeString()}</div>
        `;
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      sendBtn.addEventListener("click", send);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });

      function send() {
        const text = inputEl.value.trim();
        if (!text) return;
        socket.emit("sendData", { user: username, text });
        appendMessage(username, text, "you");
        inputEl.value = "";
        inputEl.focus();
      }

      socket.on("broadcast", (data) => {
        if (data.user === username) return; // ignore own message
        appendMessage(data.user, data.text, "other");
      });
    </script>
  </body>
</html>
